<HTML>
<HEAD>
<TITLE>
worlddata.cpp
</TITLE>
</HEAD>
<BODY>
<PRE>
<font color="blue">#include</font> <font color="maroon">"sector.h"</font>
<font color="blue">#include</font> <font color="maroon">"point.h"</font>
<font color="blue">#include</font> <font color="maroon">"worlddata.h"</font>
<font color="blue">#include</font> <font color="maroon">&#60;stdexcept&#62;</font>

<font color="blue">using</font> <font color="blue">namespace</font> world;

<font color="blue">namespace</font> cache<font color="black">{</font>

WorldData<font color="black">:</font><font color="black">:</font>~WorldData<font color="black">(</font><font color="black">)</font><font color="black">{</font>

<font color="black">}</font>

byte WorldData<font color="black">:</font><font color="black">:</font>getCollisionFlag<font color="black">(</font>Point p<font color="black">)</font><font color="black">{</font>
    <font color="blue">return</font> getCollisionFlag<font color="black">(</font>p.GetX<font color="black">(</font><font color="black">)</font>,p.GetY<font color="black">(</font><font color="black">)</font>,p.GetPlane<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
<font color="black">}</font>

byte WorldData<font color="black">:</font><font color="black">:</font>getCollisionFlag<font color="black">(</font><font color="blue">int</font> x, <font color="blue">int</font> y<font color="black">)</font><font color="black">{</font>
    <font color="blue">return</font> getCollisionFlag<font color="black">(</font>x,y,<font color="maroon">0</font><font color="black">)</font>;
<font color="black">}</font>

byte WorldData<font color="black">:</font><font color="black">:</font>getCollisionFlag<font color="black">(</font><font color="blue">int</font> x, <font color="blue">int</font> y, <font color="blue">int</font> z<font color="black">)</font><font color="black">{</font>
    Sector<font color="black">*</font> s <font color="black">=</font> getSector<font color="black">(</font>x,y<font color="black">)</font>;
    <font color="blue">if</font><font color="black">(</font>s <font color="black">=</font><font color="black">=</font> NULL<font color="black">)</font><font color="black">{</font>
        <font color="blue">return</font> <font color="maroon">0</font>;
    <font color="black">}</font>
    byte localX <font color="black">=</font> <font color="black">(</font>byte<font color="black">)</font> x%<font color="maroon">64</font>;
    byte localY <font color="black">=</font> <font color="black">(</font>byte<font color="black">)</font> y%<font color="maroon">64</font>;
    <font color="blue">return</font> s<font color="black">-</font><font color="black">&#62;</font>getCollision<font color="black">(</font>localX,localY,z<font color="black">)</font>;
<font color="black">}</font>

Sector<font color="black">*</font> WorldData<font color="black">:</font><font color="black">:</font>getSector<font color="black">(</font><font color="blue">int</font> x, <font color="blue">int</font> y<font color="black">)</font><font color="black">{</font>
    <font color="blue">int</font> sectorX <font color="black">=</font> x<font color="black">/</font><font color="maroon">64</font>;
    <font color="blue">int</font> sectorY <font color="black">=</font> y<font color="black">/</font><font color="maroon">64</font>;
    <font color="blue">int</font> index <font color="black">=</font> <font color="black">(</font>sectorX <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">16</font><font color="black">)</font> <font color="black">+</font> sectorY;
    try <font color="black">{</font>        
        <font color="blue">return</font> sectors.take<font color="black">(</font>index<font color="black">)</font>;
    <font color="black">}</font> <font color="blue">catch</font> <font color="black">(</font>out_of_range<font color="black">)</font><font color="black">{</font>
        <font color="blue">return</font> NULL;
    <font color="black">}</font>
<font color="black">}</font>

Sector<font color="black">*</font> WorldData<font color="black">:</font><font color="black">:</font>getSector<font color="black">(</font>Point p<font color="black">)</font><font color="black">{</font>
    <font color="blue">return</font> getSector<font color="black">(</font>p.GetX<font color="black">(</font><font color="black">)</font>,p.GetY<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
<font color="black">}</font>

Sector<font color="black">*</font> WorldData<font color="black">:</font><font color="black">:</font>allocate<font color="black">(</font><font color="blue">int</font> sectorX, <font color="blue">int</font> sectorY<font color="black">)</font><font color="black">{</font>
    <font color="blue">int</font> key <font color="black">=</font> <font color="black">(</font>sectorX <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">16</font><font color="black">)</font> <font color="black">+</font> sectorY;
    Sector<font color="black">*</font> s <font color="black">=</font> <font color="blue">new</font> Sector<font color="black">(</font><font color="black">)</font>;
    sectors.insert<font color="black">(</font>key, s<font color="black">)</font>;
    <font color="blue">return</font> s;
<font color="black">}</font>

<font color="blue">void</font> WorldData<font color="black">:</font><font color="black">:</font>remove<font color="black">(</font><font color="blue">int</font> sectorX, <font color="blue">int</font> sectorY<font color="black">)</font><font color="black">{</font>
    <font color="blue">int</font> key <font color="black">=</font> <font color="black">(</font>sectorX <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">16</font><font color="black">)</font> <font color="black">+</font> sectorY;
    try <font color="black">{</font>
        Sector<font color="black">*</font> s <font color="black">=</font> sectors.take<font color="black">(</font>key<font color="black">)</font>;
        sectors.erase<font color="black">(</font>sectors.find<font color="black">(</font>key<font color="black">)</font><font color="black">)</font>;
        <font color="blue">delete</font> s;
    <font color="black">}</font> <font color="blue">catch</font> <font color="black">(</font>out_of_range<font color="black">)</font><font color="black">{</font>
        <font color="green">//sector not found (key invalid)</font>
    <font color="black">}</font>
<font color="black">}</font>

<font color="black">}</font>

</PRE>
</BODY>
</HTML>
