<HTML>
<HEAD>
<TITLE>
main.cpp
</TITLE>
</HEAD>
<BODY>
<PRE>
<font color="blue">#include</font> <font color="maroon">"mainwindow.h"</font>
<font color="blue">#include</font> <font color="maroon">"javaenv.h"</font>

<font color="blue">#include</font> <font color="maroon">&#60;cstdlib&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;iostream&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;stdexcept&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;fstream&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;sstream&#62;</font>

<font color="blue">#include</font> <font color="maroon">&#60;QApplication&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;QLabel&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;QtConcurrent/QtConcurrent&#62;</font>

<font color="blue">using</font> <font color="blue">namespace</font> std;
<font color="blue">using</font> <font color="blue">namespace</font> jni;

std<font color="black">:</font><font color="black">:</font>ofstream logStream;

<font color="green">// Custom message handler for Qt messages. It prints the message to the</font>
<font color="green">// standard error stream prepended with the appropriate level identifier.</font>
<font color="blue">void</font> PGMessageHandler<font color="black">(</font>QtMsgType type, <font color="blue">const</font> QMessageLogContext<font color="black">&</font> context, <font color="blue">const</font> QString<font color="black">&</font> msg<font color="black">)</font> <font color="black">{</font>
  stringstream out;
  <font color="blue">switch</font> <font color="black">(</font>type<font color="black">)</font> <font color="black">{</font>
    <font color="blue">case</font> QtDebugMsg<font color="black">:</font>
      out <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"Info     | "</font>;
      <font color="blue">break</font>;
    <font color="blue">case</font> QtWarningMsg<font color="black">:</font>
      out <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"Warning  | "</font>;
      <font color="blue">break</font>;
    <font color="blue">case</font> QtCriticalMsg<font color="black">:</font>
      out <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"Critical | "</font>;
      <font color="blue">break</font>;
    <font color="blue">case</font> QtFatalMsg<font color="black">:</font>
      out <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"Fatal    | "</font>;
      <font color="blue">break</font>;
    <font color="blue">default</font><font color="black">:</font>
      out <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"         | "</font>;
  <font color="black">}</font>
  <font color="green">// We add information from the QMessageLogContext object allowing us to</font>
  <font color="green">// localize the origin of the message, also making it easier to trace</font>
  <font color="green">// bugs and errors. We don't do this for release builds</font>
<font color="blue">#ifdef</font> DEBUG
  out <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"At "</font> <font color="black">&#60;</font><font color="black">&#60;</font> context.file <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">":"</font> <font color="black">&#60;</font><font color="black">&#60;</font> context.<font color="blue">line</font>
      <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">" ("</font> <font color="black">&#60;</font><font color="black">&#60;</font> context.function <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">")"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl
      <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"         |&#62;  "</font>;
<font color="blue">#endif</font>
  out <font color="black">&#60;</font><font color="black">&#60;</font> qPrintable<font color="black">(</font>msg<font color="black">)</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl;
  string logrecord <font color="black">=</font> out.str<font color="black">(</font><font color="black">)</font>;
  logStream <font color="black">&#60;</font><font color="black">&#60;</font> logrecord;
  cerr <font color="black">&#60;</font><font color="black">&#60;</font> logrecord;
  <font color="blue">if</font> <font color="black">(</font>type <font color="black">=</font><font color="black">=</font> QtFatalMsg<font color="black">)</font> <font color="black">{</font>
    abort<font color="black">(</font><font color="black">)</font>;
  <font color="black">}</font>
<font color="black">}</font>

JavaEnv<font color="black">*</font> RunJavaVM<font color="black">(</font><font color="black">)</font> <font color="black">{</font>
    JavaEnv<font color="black">*</font> env <font color="black">=</font> <font color="blue">new</font> JavaEnv<font color="black">(</font><font color="black">)</font>;
    qDebug<font color="black">(</font><font color="black">)</font> <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"Starting Java Virtual Machine"</font>;
    try <font color="black">{</font>
        env<font color="black">-</font><font color="black">&#62;</font>Start<font color="black">(</font><font color="black">)</font>;
    <font color="black">}</font> <font color="blue">catch</font> <font color="black">(</font>runtime_error e<font color="black">)</font> <font color="black">{</font>
        qWarning<font color="black">(</font><font color="black">)</font> <font color="black">&#60;</font><font color="black">&#60;</font> e.what<font color="black">(</font><font color="black">)</font>;
    <font color="black">}</font>
    qDebug<font color="black">(</font><font color="black">)</font> <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"Java Virtual Machine started"</font>;
    <font color="blue">return</font> env;
<font color="black">}</font>

<font color="blue">bool</font> openWindows <font color="black">=</font> <font color="blue">false</font>;

<font color="blue">#ifdef</font> Q_OS_WIN
<font color="green">// On windows we can use the EnumWindows function to check the open windows</font>
BOOL CALLBACK EnumWindowsProc<font color="black">(</font>HWND hWnd, <font color="blue">long</font> lParam<font color="black">)</font> <font color="black">{</font>
  <font color="blue">if</font> <font color="black">(</font>IsWindowVisible<font color="black">(</font>hWnd<font color="black">)</font><font color="black">)</font> <font color="black">{</font>
      openWindows <font color="black">=</font> <font color="blue">true</font>;
  <font color="black">}</font>
  <font color="blue">return</font> TRUE;
<font color="black">}</font>
<font color="blue">void</font> WaitForShutdown<font color="black">(</font><font color="black">)</font> <font color="black">{</font>
  <font color="blue">do</font> <font color="black">{</font>
    openWindows <font color="black">=</font> <font color="blue">false</font>;
    EnumWindows<font color="black">(</font>EnumWindowsProc, <font color="maroon">0</font><font color="black">)</font>;
    QThread<font color="black">:</font><font color="black">:</font>currentThread<font color="black">(</font><font color="black">)</font><font color="black">-</font><font color="black">&#62;</font>sleep<font color="black">(</font><font color="maroon">5</font><font color="black">)</font>;
  <font color="black">}</font> <font color="blue">while</font> <font color="black">(</font>openWindows<font color="black">)</font>;
  qDebug<font color="black">(</font><font color="black">)</font> <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"PowerGrid terminating"</font>;
<font color="black">}</font>
<font color="blue">#else</font>
<font color="blue">void</font> WaitForShutdown<font color="black">(</font><font color="black">)</font> <font color="black">{</font><font color="black">}</font>
<font color="blue">#endif</font>

<font color="blue">int</font> main<font color="black">(</font><font color="blue">int</font> argc, <font color="blue">char</font> <font color="black">*</font>argv<font color="black">[</font><font color="black">]</font><font color="black">)</font> <font color="black">{</font>
  <font color="green">// Open the log file for writing</font>
  logStream.open<font color="black">(</font><font color="maroon">"PowerGrid.log"</font>, std<font color="black">:</font><font color="black">:</font>ofstream<font color="black">:</font><font color="black">:</font>out <font color="black">|</font> std<font color="black">:</font><font color="black">:</font>ofstream<font color="black">:</font><font color="black">:</font>trunc<font color="black">)</font>;
  logStream <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"PowerGrid "</font> <font color="black">&#60;</font><font color="black">&#60;</font> qPrintable<font color="black">(</font>POWERGRID_VERSION<font color="black">)</font> <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">" log file"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl;
  <font color="green">// Install the message handler for Qt.</font>
  qInstallMessageHandler<font color="black">(</font>PGMessageHandler<font color="black">)</font>;

  QThread<font color="black">*</font> current <font color="black">=</font> QThread<font color="black">:</font><font color="black">:</font>currentThread<font color="black">(</font><font color="black">)</font>;
  current<font color="black">-</font><font color="black">&#62;</font>setObjectName<font color="black">(</font><font color="maroon">"PG-main"</font><font color="black">)</font>;

  QFuture<font color="black">&#60;</font>JavaEnv<font color="black">*</font><font color="black">&#62;</font> futureRunJVM <font color="black">=</font> QtConcurrent<font color="black">:</font><font color="black">:</font>run<font color="black">(</font>RunJavaVM<font color="black">)</font>;

  QApplication a<font color="black">(</font>argc, argv<font color="black">)</font>;

  <font color="green">// Show our main window</font>
  MainWindow w;
  w.setGeometry<font color="black">(</font><font color="maroon">40</font>, <font color="maroon">60</font>, w.width<font color="black">(</font><font color="black">)</font>, w.height<font color="black">(</font><font color="black">)</font><font color="black">)</font>;

  <font color="green">// Now we wait until the Java VM is started and collect the resulting JavaEnv instance</font>
  JavaEnv<font color="black">*</font> environment <font color="black">=</font> futureRunJVM.result<font color="black">(</font><font color="black">)</font>;

  <font color="blue">if</font> <font color="black">(</font>environment <font color="black">=</font><font color="black">=</font> NULL<font color="black">)</font> <font color="black">{</font>
    qWarning<font color="black">(</font><font color="black">)</font> <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"Could not detect running Java VM"</font>;
    w.updateVersionInfo<font color="black">(</font>QStringLiteral<font color="black">(</font><font color="maroon">"No Java VM detected"</font><font color="black">)</font><font color="black">)</font>;
  <font color="black">}</font> <font color="blue">else</font> <font color="black">{</font>
    <font color="green">// &#60;&#60; Add startup code here if it does require the Java VM</font>
    QString version <font color="black">=</font> environment<font color="black">-</font><font color="black">&#62;</font>GetEnvironmentVersion<font color="black">(</font><font color="black">)</font>;
    qDebug<font color="black">(</font><font color="black">)</font> <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"Java Version: "</font> <font color="black">&#60;</font><font color="black">&#60;</font> version;
    w.updateVersionInfo<font color="black">(</font>version<font color="black">)</font>;
  <font color="black">}</font>

  w.show<font color="black">(</font><font color="black">)</font>;

  <font color="green">// enter the Qt message loop</font>
  <font color="blue">int</font> result <font color="black">=</font> a.exec<font color="black">(</font><font color="black">)</font>;

  qDebug<font color="black">(</font><font color="black">)</font> <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"PowerGrid window closed"</font>;

  WaitForShutdown<font color="black">(</font><font color="black">)</font>;

  <font color="blue">return</font> result;
<font color="black">}</font>

</PRE>
</BODY>
</HTML>
