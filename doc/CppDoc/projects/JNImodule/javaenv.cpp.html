<HTML>
<HEAD>
<TITLE>
javaenv.cpp
</TITLE>
</HEAD>
<BODY>
<PRE>
<font color="blue">#include</font> <font color="maroon">"javaenv.h"</font>
<font color="blue">#include</font> <font color="maroon">&#60;stdexcept&#62;</font>
<font color="blue">#include</font> <font color="maroon">"jniexception.h"</font>
<font color="blue">#include</font> <font color="maroon">&#60;QDir&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;iostream&#62;</font>

<font color="blue">namespace</font> jni <font color="black">{</font>
  <font color="blue">using</font> <font color="blue">namespace</font> std;

  <font color="blue">class</font> JNIMethod;

  JavaEnv<font color="black">:</font><font color="black">:</font>JavaEnv<font color="black">(</font><font color="black">)</font> <font color="black">:</font> QObject<font color="black">(</font><font color="black">)</font> <font color="black">{</font>
    running <font color="black">=</font> JNI_FALSE;
    setObjectName<font color="black">(</font><font color="maroon">"JavaEnvironment"</font><font color="black">)</font>;
  <font color="black">}</font>

  JNIEnv<font color="black">*</font> JavaEnv<font color="black">:</font><font color="black">:</font>GetEnv<font color="black">(</font><font color="black">)</font> <font color="black">{</font>
    QThread<font color="black">*</font> current <font color="black">=</font> QThread<font color="black">:</font><font color="black">:</font>currentThread<font color="black">(</font><font color="black">)</font>;
    QMap<font color="black">&#60;</font>QThread<font color="black">*</font>,JNIEnv<font color="black">*</font><font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>const_iterator it <font color="black">=</font> environments.find<font color="black">(</font>current<font color="black">)</font>;
    QMap<font color="black">&#60;</font>QThread<font color="black">*</font>,JNIEnv<font color="black">*</font><font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>const_iterator end <font color="black">=</font> environments.cend<font color="black">(</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font>it <font color="black">=</font><font color="black">=</font> end<font color="black">)</font> <font color="black">{</font>
      JNIEnv<font color="black">*</font> env;
      <font color="blue">if</font> <font color="black">(</font>jvm <font color="black">=</font><font color="black">=</font> NULL<font color="black">)</font> <font color="black">{</font>
        <font color="blue">throw</font> jni_error<font color="black">(</font><font color="maroon">"JVM not started"</font><font color="black">)</font>;
      <font color="black">}</font>
      jvm<font color="black">-</font><font color="black">&#62;</font>AttachCurrentThread<font color="black">(</font>reinterpret_cast<font color="black">&#60;</font><font color="blue">void</font><font color="black">*</font><font color="black">*</font><font color="black">&#62;</font><font color="black">(</font><font color="black">&</font>env<font color="black">)</font>, NULL<font color="black">)</font>;
      environments.insert<font color="black">(</font>current, env<font color="black">)</font>;
      qDebug<font color="black">(</font><font color="black">)</font> <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"Created JNIEnv for thread:"</font> <font color="black">&#60;</font><font color="black">&#60;</font> current<font color="black">-</font><font color="black">&#62;</font>objectName<font color="black">(</font><font color="black">)</font>;
      <font color="blue">return</font> env;
    <font color="black">}</font> <font color="blue">else</font> <font color="black">{</font>
      <font color="blue">return</font> it.value<font color="black">(</font><font color="black">)</font>;
    <font color="black">}</font>
  <font color="black">}</font>

  <font color="green">// Intialize and set up the environment</font>
  <font color="blue">void</font> JavaEnv<font color="black">:</font><font color="black">:</font>Start<font color="black">(</font><font color="black">)</font> <font color="black">{</font>
    <font color="blue">if</font> <font color="black">(</font>running<font color="black">)</font> <font color="black">{</font>
      <font color="blue">throw</font> logic_error<font color="black">(</font><font color="maroon">"JVM already running."</font><font color="black">)</font>;
    <font color="black">}</font>

    QString classpath<font color="black">(</font><font color="maroon">"-Djava.class.path="</font><font color="black">)</font>;
<font color="blue">#ifndef</font> Q_OS_DARWIN
    <font color="green">// In the case of Mac OS, the jagexappletviewer jar file is not accessible through the</font>
    <font color="green">// native Runescape loader and must be packaged along with the application.</font>
    QChar sep <font color="black">=</font> QDir<font color="black">:</font><font color="black">:</font>separator<font color="black">(</font><font color="black">)</font>;
    QString home <font color="black">=</font> QDir<font color="black">:</font><font color="black">:</font>homePath<font color="black">(</font><font color="black">)</font>.replace<font color="black">(</font><font color="maroon">"/"</font>, sep<font color="black">)</font>;
    classpath.append<font color="black">(</font>home<font color="black">)</font>.append<font color="black">(</font>sep<font color="black">)</font>.append<font color="black">(</font><font color="maroon">"jagexcache"</font><font color="black">)</font>.append<font color="black">(</font>sep<font color="black">)</font>
             .append<font color="black">(</font><font color="maroon">"jagexlauncher"</font><font color="black">)</font>.append<font color="black">(</font>sep<font color="black">)</font>.append<font color="black">(</font><font color="maroon">"bin"</font><font color="black">)</font>.append<font color="black">(</font>sep<font color="black">)</font>;
<font color="blue">#endif</font>
    classpath.append<font color="black">(</font><font color="maroon">"jagexappletviewer.jar"</font><font color="black">)</font>;

    <font color="green">// We need to store the intermediate QByteArray, since the char* is not copied and as such</font>
    <font color="green">// the pointer becomes invalid after the data() function returns.</font>
    QByteArray cpArray <font color="black">=</font> classpath.toUtf8<font color="black">(</font><font color="black">)</font>;

    JavaVMInitArgs vmargs;
    vmargs.version            <font color="black">=</font> JNI_VERSION_1_6;
    vmargs.ignoreUnrecognized <font color="black">=</font> JNI_FALSE;

    <font color="green">// the JVM options themselves. They are all used because these are the same</font>
    <font color="green">// that the official Runescape loader uses. We also use them since we're trying</font>
    <font color="green">// to mimic the Runescape loader as accurately as possible.</font>
    JavaVMOption options<font color="black">[</font><font color="maroon">10</font><font color="black">]</font>;
    options<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>.optionString  <font color="black">=</font> const_cast<font color="black">&#60;</font><font color="blue">char</font><font color="black">*</font><font color="black">&#62;</font><font color="black">(</font>cpArray.data<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
    options<font color="black">[</font><font color="maroon">1</font><font color="black">]</font>.optionString  <font color="black">=</font> const_cast<font color="black">&#60;</font><font color="blue">char</font><font color="black">*</font><font color="black">&#62;</font><font color="black">(</font><font color="maroon">"-Dsun.java2d.noddraw=true"</font><font color="black">)</font>;
    options<font color="black">[</font><font color="maroon">2</font><font color="black">]</font>.optionString  <font color="black">=</font> const_cast<font color="black">&#60;</font><font color="blue">char</font><font color="black">*</font><font color="black">&#62;</font><font color="black">(</font><font color="maroon">"-Dcom.jagex.config=http://www.runescape.com/k=3/l=$(language:0)/jav_config.ws"</font><font color="black">)</font>;
    options<font color="black">[</font><font color="maroon">3</font><font color="black">]</font>.optionString  <font color="black">=</font> const_cast<font color="black">&#60;</font><font color="blue">char</font><font color="black">*</font><font color="black">&#62;</font><font color="black">(</font><font color="maroon">"-Xmx256m"</font><font color="black">)</font>;
    options<font color="black">[</font><font color="maroon">4</font><font color="black">]</font>.optionString  <font color="black">=</font> const_cast<font color="black">&#60;</font><font color="blue">char</font><font color="black">*</font><font color="black">&#62;</font><font color="black">(</font><font color="maroon">"-Xss2m"</font><font color="black">)</font>;
    options<font color="black">[</font><font color="maroon">5</font><font color="black">]</font>.optionString  <font color="black">=</font> const_cast<font color="black">&#60;</font><font color="blue">char</font><font color="black">*</font><font color="black">&#62;</font><font color="black">(</font><font color="maroon">"-XX:CompileThreshold=1500"</font><font color="black">)</font>;
    options<font color="black">[</font><font color="maroon">6</font><font color="black">]</font>.optionString  <font color="black">=</font> const_cast<font color="black">&#60;</font><font color="blue">char</font><font color="black">*</font><font color="black">&#62;</font><font color="black">(</font><font color="maroon">"-Xincgc"</font><font color="black">)</font>;
    options<font color="black">[</font><font color="maroon">7</font><font color="black">]</font>.optionString  <font color="black">=</font> const_cast<font color="black">&#60;</font><font color="blue">char</font><font color="black">*</font><font color="black">&#62;</font><font color="black">(</font><font color="maroon">"-XX:+UseConcMarkSweepGC"</font><font color="black">)</font>;
    options<font color="black">[</font><font color="maroon">8</font><font color="black">]</font>.optionString  <font color="black">=</font> const_cast<font color="black">&#60;</font><font color="blue">char</font><font color="black">*</font><font color="black">&#62;</font><font color="black">(</font><font color="maroon">"-XX:+UseParNewGC"</font><font color="black">)</font>;
    options<font color="black">[</font><font color="maroon">9</font><font color="black">]</font>.optionString  <font color="black">=</font> const_cast<font color="black">&#60;</font><font color="blue">char</font><font color="black">*</font><font color="black">&#62;</font><font color="black">(</font><font color="maroon">"-Xcheck:jni"</font><font color="black">)</font>; <font color="green">// debug; checks incoming JNI calls and the parameters</font>

    vmargs.options <font color="black">=</font> options;
    vmargs.nOptions <font color="black">=</font> <font color="maroon">10</font>;

    JNIEnv<font color="black">*</font> env <font color="black">=</font> NULL;

    JNI_CreateJavaVM<font color="black">(</font><font color="black">&</font>jvm, <font color="black">(</font><font color="blue">void</font><font color="black">*</font><font color="black">*</font><font color="black">)</font><font color="black">&</font>env, <font color="black">&</font>vmargs<font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font>env <font color="black">!</font><font color="black">=</font> NULL<font color="black">)</font> <font color="black">{</font>
      QThread<font color="black">*</font> current <font color="black">=</font> QThread<font color="black">:</font><font color="black">:</font>currentThread<font color="black">(</font><font color="black">)</font>;
      environments.insert<font color="black">(</font>current, env<font color="black">)</font>;
    <font color="black">}</font> <font color="blue">else</font> <font color="black">{</font>
      <font color="blue">throw</font> jni_error<font color="black">(</font><font color="maroon">"Failed to create environment"</font><font color="black">)</font>;
    <font color="black">}</font>

    <font color="green">// We redirect log traffic from System.out to a logfile instead, to reduce the spam in the console window</font>
    <font color="green">// Runescape tends to print "Received command: _12" and similar all the time.</font>
    JNIClass<font color="black">*</font> system <font color="black">=</font> GetClass<font color="black">(</font><font color="maroon">"java/lang/System"</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font>system <font color="black">=</font><font color="black">=</font> NULL<font color="black">)</font> <font color="blue">throw</font> jni_error<font color="black">(</font><font color="maroon">"failed to get System class"</font><font color="black">)</font>;
    jclass s <font color="black">=</font> <font color="black">(</font>jclass<font color="black">)</font> system<font color="black">-</font><font color="black">&#62;</font>GetJavaObject<font color="black">(</font><font color="black">)</font>;
    jfieldID out <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>GetStaticFieldID<font color="black">(</font>s, <font color="maroon">"out"</font>, <font color="maroon">"Ljava/io/PrintStream;"</font><font color="black">)</font>;
    jfieldID err <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>GetStaticFieldID<font color="black">(</font>s, <font color="maroon">"err"</font>, <font color="maroon">"Ljava/io/PrintStream;"</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font>out <font color="black">=</font><font color="black">=</font> NULL <font color="black">|</font><font color="black">|</font> err <font color="black">=</font><font color="black">=</font> NULL<font color="black">)</font> <font color="blue">throw</font> jni_error<font color="black">(</font><font color="maroon">"failed to get System field"</font><font color="black">)</font>;

    JNIClass<font color="black">*</font> printstream <font color="black">=</font> GetClass<font color="black">(</font><font color="maroon">"java/io/PrintStream"</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font>printstream <font color="black">=</font><font color="black">=</font> NULL<font color="black">)</font> <font color="blue">throw</font> jni_error<font color="black">(</font><font color="maroon">"failed to get PrintStream class"</font><font color="black">)</font>;
    jclass ps <font color="black">=</font> <font color="black">(</font>jclass<font color="black">)</font>printstream<font color="black">-</font><font color="black">&#62;</font>GetJavaObject<font color="black">(</font><font color="black">)</font>;
    jmethodID initPrintStream <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>GetMethodID<font color="black">(</font>ps, <font color="maroon">"&#60;init&#62;"</font>, <font color="maroon">"(Ljava/lang/String;)V"</font><font color="black">)</font>;
    jstring file <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>NewStringUTF<font color="black">(</font><font color="maroon">"runescape.log"</font><font color="black">)</font>;
    jobject newout <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>NewObject<font color="black">(</font>ps, initPrintStream, file<font color="black">)</font>;
    env<font color="black">-</font><font color="black">&#62;</font>SetStaticObjectField<font color="black">(</font>s, out, newout<font color="black">)</font>;
    env<font color="black">-</font><font color="black">&#62;</font>SetStaticObjectField<font color="black">(</font>s, err, newout<font color="black">)</font>;

    <font color="green">// Now we start the Jagex Applet Viewer's main class.</font>
    jclass c <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>FindClass<font color="black">(</font><font color="maroon">"jagexappletviewer"</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font>c <font color="black">=</font><font color="black">=</font> NULL<font color="black">)</font> qFatal<font color="black">(</font><font color="maroon">"jagexappletviewer class not found"</font><font color="black">)</font>;
    jmethodID main <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>GetStaticMethodID<font color="black">(</font>c, <font color="maroon">"main"</font>, <font color="maroon">"([Ljava/lang/String;)V"</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font>main <font color="black">=</font><font color="black">=</font> NULL<font color="black">)</font> qFatal<font color="black">(</font><font color="maroon">"main method not found"</font><font color="black">)</font>;

    jobjectArray args <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>NewObjectArray<font color="black">(</font><font color="maroon">1</font>, env<font color="black">-</font><font color="black">&#62;</font>FindClass<font color="black">(</font><font color="maroon">"java/lang/String"</font><font color="black">)</font>, env<font color="black">-</font><font color="black">&#62;</font>NewStringUTF<font color="black">(</font><font color="maroon">"runescape"</font><font color="black">)</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font>args <font color="black">=</font><font color="black">=</font> NULL<font color="black">)</font> qFatal<font color="black">(</font><font color="maroon">"Failed to create argument array"</font><font color="black">)</font>;

    env<font color="black">-</font><font color="black">&#62;</font>CallStaticVoidMethod<font color="black">(</font>c, main, args<font color="black">)</font>;

    running <font color="black">=</font> JNI_TRUE;

    emit started<font color="black">(</font><font color="black">)</font>;
  <font color="black">}</font>

  <font color="green">// Get basic JNI element types</font>
  JNIClass<font color="black">*</font> JavaEnv<font color="black">:</font><font color="black">:</font>GetClass<font color="black">(</font><font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> <font color="blue">name</font><font color="black">)</font> <font color="black">{</font>
    QString n <font color="black">(</font><font color="blue">name</font><font color="black">)</font>;
    QMap<font color="black">&#60;</font>QString,JNIClass<font color="black">*</font><font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>iterator it <font color="black">=</font> classes.find<font color="black">(</font>n<font color="black">)</font>;
    QMap<font color="black">&#60;</font>QString,JNIClass<font color="black">*</font><font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>iterator end <font color="black">=</font> classes.end<font color="black">(</font><font color="black">)</font>;
    JNIClass<font color="black">*</font> jnic <font color="black">=</font> NULL;
    <font color="blue">if</font> <font color="black">(</font>it <font color="black">=</font><font color="black">=</font> end<font color="black">)</font> <font color="black">{</font>
      JNIEnv<font color="black">*</font> env <font color="black">=</font> GetEnv<font color="black">(</font><font color="black">)</font>;
      jclass cls <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>FindClass<font color="black">(</font><font color="blue">name</font><font color="black">)</font>;
      <font color="blue">if</font> <font color="black">(</font>cls <font color="black">=</font><font color="black">=</font> NULL<font color="black">)</font> <font color="black">{</font>
        qWarning<font color="black">(</font><font color="black">)</font> <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"Request for non-existing class:"</font> <font color="black">&#60;</font><font color="black">&#60;</font> n;
        <font color="blue">return</font> NULL;
      <font color="black">}</font>
      jnic <font color="black">=</font> <font color="blue">new</font> JNIClass<font color="black">(</font>cls, <font color="blue">this</font><font color="black">)</font>;
      classes.insert<font color="black">(</font>n, jnic<font color="black">)</font>;
      qDebug<font color="black">(</font><font color="black">)</font> <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"Registered JNIClass with name:"</font> <font color="black">&#60;</font><font color="black">&#60;</font> n;
    <font color="black">}</font> <font color="blue">else</font> <font color="black">{</font>
      jnic <font color="black">=</font> it.value<font color="black">(</font><font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">return</font> jnic;
  <font color="black">}</font>

  jmethodID JavaEnv<font color="black">:</font><font color="black">:</font>GetMethodID<font color="black">(</font>JNIClass<font color="black">*</font> c, <font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> <font color="blue">name</font>, <font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> signature<font color="black">)</font> <font color="black">{</font>
    JNIEnv<font color="black">*</font> env <font color="black">=</font> GetEnv<font color="black">(</font><font color="black">)</font>;
    jmethodID meth <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>GetMethodID<font color="black">(</font>static_cast<font color="black">&#60;</font>jclass<font color="black">&#62;</font><font color="black">(</font>c<font color="black">-</font><font color="black">&#62;</font>GetJObject<font color="black">(</font><font color="black">)</font><font color="black">)</font>, <font color="blue">name</font>, signature<font color="black">)</font>;
    <font color="blue">return</font> meth;
  <font color="black">}</font>

  jmethodID JavaEnv<font color="black">:</font><font color="black">:</font>GetStaticMethodID<font color="black">(</font>JNIClass<font color="black">*</font> c, <font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> <font color="blue">name</font>, <font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> signature<font color="black">)</font> <font color="black">{</font>
    JNIEnv<font color="black">*</font> env <font color="black">=</font> GetEnv<font color="black">(</font><font color="black">)</font>;
    jmethodID meth <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>GetStaticMethodID<font color="black">(</font>static_cast<font color="black">&#60;</font>jclass<font color="black">&#62;</font><font color="black">(</font>c<font color="black">-</font><font color="black">&#62;</font>GetJObject<font color="black">(</font><font color="black">)</font><font color="black">)</font>, <font color="blue">name</font>, signature<font color="black">)</font>;
    <font color="blue">return</font> meth;
  <font color="black">}</font>

  QString JavaEnv<font color="black">:</font><font color="black">:</font>GetEnvironmentVersion<font color="black">(</font><font color="black">)</font> <font color="black">{</font>
    <font color="blue">if</font> <font color="black">(</font>running<font color="black">)</font> <font color="black">{</font>
      JNIEnv<font color="black">*</font> env <font color="black">=</font> GetEnv<font color="black">(</font><font color="black">)</font>;
      jclass system <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>FindClass<font color="black">(</font><font color="maroon">"java/lang/System"</font><font color="black">)</font>;
      <font color="blue">if</font> <font color="black">(</font>system <font color="black">=</font><font color="black">=</font> NULL<font color="black">)</font> <font color="black">{</font>
        <font color="blue">throw</font> jni_error<font color="black">(</font><font color="maroon">"java.lang.System class not found"</font><font color="black">)</font>;
      <font color="black">}</font>
      jmethodID getProperty <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>GetStaticMethodID<font color="black">(</font>system, <font color="maroon">"getProperty"</font>, <font color="maroon">"(Ljava/lang/String;)Ljava/lang/String;"</font><font color="black">)</font>;
      <font color="blue">if</font> <font color="black">(</font>getProperty <font color="black">=</font><font color="black">=</font> NULL<font color="black">)</font> <font color="black">{</font>
        <font color="blue">throw</font> jni_error<font color="black">(</font><font color="maroon">"java.lang.System.getProperty method not found"</font><font color="black">)</font>;
      <font color="black">}</font>

      jstring infoStr <font color="black">=</font> <font color="black">(</font>jstring<font color="black">)</font> env<font color="black">-</font><font color="black">&#62;</font>CallStaticObjectMethod<font color="black">(</font>system, getProperty, env<font color="black">-</font><font color="black">&#62;</font>NewStringUTF<font color="black">(</font><font color="maroon">"java.version"</font><font color="black">)</font><font color="black">)</font>;
      QString info <font color="black">(</font>env<font color="black">-</font><font color="black">&#62;</font>GetStringUTFChars<font color="black">(</font>infoStr, NULL<font color="black">)</font><font color="black">)</font>;
      <font color="blue">return</font> info;
    <font color="black">}</font> <font color="blue">else</font> <font color="black">{</font>
      <font color="blue">return</font> QStringLiteral<font color="black">(</font><font color="maroon">"Java VM not running"</font><font color="black">)</font>;
    <font color="black">}</font>
  <font color="black">}</font>

  <font color="green">// Non-static Method Invocations</font>

  jobject JavaEnv<font color="black">:</font><font color="black">:</font>CallObjectMethod<font color="black">(</font>jobject obj, jmethodID method, uint n_args, ...<font color="black">)</font> <font color="black">{</font>
    va_list args;
    va_start<font color="black">(</font>args, n_args<font color="black">)</font>;
    JNIEnv<font color="black">*</font> env <font color="black">=</font> GetEnv<font color="black">(</font><font color="black">)</font>;
    jobject result <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>CallObjectMethodV<font color="black">(</font>obj, method, args<font color="black">)</font>;
    va_end<font color="black">(</font>args<font color="black">)</font>;

    <font color="blue">return</font> result;
  <font color="black">}</font>

  jint JavaEnv<font color="black">:</font><font color="black">:</font>CallIntMethod<font color="black">(</font>jobject obj, jmethodID method, uint n_args, ...<font color="black">)</font> <font color="black">{</font>
    va_list args;
    va_start<font color="black">(</font>args, n_args<font color="black">)</font>;
    JNIEnv<font color="black">*</font> env <font color="black">=</font> GetEnv<font color="black">(</font><font color="black">)</font>;
    jint result <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>CallIntMethodV<font color="black">(</font>obj, method, args<font color="black">)</font>;
    va_end<font color="black">(</font>args<font color="black">)</font>;
    <font color="blue">return</font> result;
  <font color="black">}</font>

  jdouble JavaEnv<font color="black">:</font><font color="black">:</font>CallDoubleMethod<font color="black">(</font>jobject obj, jmethodID method, uint n_args, ...<font color="black">)</font> <font color="black">{</font>
    va_list args;
    va_start<font color="black">(</font>args, n_args<font color="black">)</font>;
    JNIEnv<font color="black">*</font> env <font color="black">=</font> GetEnv<font color="black">(</font><font color="black">)</font>;
    jdouble result <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>CallDoubleMethodV<font color="black">(</font>obj, method, args<font color="black">)</font>;
    va_end<font color="black">(</font>args<font color="black">)</font>;
    <font color="blue">return</font> result;
  <font color="black">}</font>

  jboolean JavaEnv<font color="black">:</font><font color="black">:</font>CallBooleanMethod<font color="black">(</font>jobject obj, jmethodID method, uint n_args, ...<font color="black">)</font> <font color="black">{</font>
    va_list args;
    va_start<font color="black">(</font>args, n_args<font color="black">)</font>;
    JNIEnv<font color="black">*</font> env <font color="black">=</font> GetEnv<font color="black">(</font><font color="black">)</font>;
    jboolean result <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>CallBooleanMethodV<font color="black">(</font>obj, method, args<font color="black">)</font>;
    va_end<font color="black">(</font>args<font color="black">)</font>;
    <font color="blue">return</font> result;
  <font color="black">}</font>

  jfloat JavaEnv<font color="black">:</font><font color="black">:</font>CallFloatMethod<font color="black">(</font>jobject obj, jmethodID method, uint n_args, ...<font color="black">)</font> <font color="black">{</font>
    va_list args;
    va_start<font color="black">(</font>args, n_args<font color="black">)</font>;
    JNIEnv<font color="black">*</font> env <font color="black">=</font> GetEnv<font color="black">(</font><font color="black">)</font>;
    jfloat result <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>CallFloatMethodV<font color="black">(</font>obj, method, args<font color="black">)</font>;
    va_end<font color="black">(</font>args<font color="black">)</font>;
    <font color="blue">return</font> result;
  <font color="black">}</font>

  jbyte JavaEnv<font color="black">:</font><font color="black">:</font>CallByteMethod<font color="black">(</font>jobject obj, jmethodID method, uint n_args, ...<font color="black">)</font> <font color="black">{</font>
    va_list args;
    va_start<font color="black">(</font>args, n_args<font color="black">)</font>;
    JNIEnv<font color="black">*</font> env <font color="black">=</font> GetEnv<font color="black">(</font><font color="black">)</font>;
    jbyte result <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>CallByteMethodV<font color="black">(</font>obj, method, args<font color="black">)</font>;
    va_end<font color="black">(</font>args<font color="black">)</font>;
    <font color="blue">return</font> result;
  <font color="black">}</font>

  jchar JavaEnv<font color="black">:</font><font color="black">:</font>CallCharMethod<font color="black">(</font>jobject obj, jmethodID method, uint n_args, ...<font color="black">)</font> <font color="black">{</font>
    va_list args;
    va_start<font color="black">(</font>args, n_args<font color="black">)</font>;
    JNIEnv<font color="black">*</font> env <font color="black">=</font> GetEnv<font color="black">(</font><font color="black">)</font>;
    jchar result <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>CallCharMethodV<font color="black">(</font>obj, method, args<font color="black">)</font>;
    va_end<font color="black">(</font>args<font color="black">)</font>;
    <font color="blue">return</font> result;
  <font color="black">}</font>

  jlong JavaEnv<font color="black">:</font><font color="black">:</font>CallLongMethod<font color="black">(</font>jobject obj, jmethodID method, uint n_args, ...<font color="black">)</font> <font color="black">{</font>
    va_list args;
    va_start<font color="black">(</font>args, n_args<font color="black">)</font>;
    JNIEnv<font color="black">*</font> env <font color="black">=</font> GetEnv<font color="black">(</font><font color="black">)</font>;
    jlong result <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>CallLongMethodV<font color="black">(</font>obj, method, args<font color="black">)</font>;
    va_end<font color="black">(</font>args<font color="black">)</font>;
    <font color="blue">return</font> result;
  <font color="black">}</font>

  jshort JavaEnv<font color="black">:</font><font color="black">:</font>CallShortMethod<font color="black">(</font>jobject obj, jmethodID method, uint n_args, ...<font color="black">)</font> <font color="black">{</font>
    va_list args;
    va_start<font color="black">(</font>args, n_args<font color="black">)</font>;
    JNIEnv<font color="black">*</font> env <font color="black">=</font> GetEnv<font color="black">(</font><font color="black">)</font>;
    jshort result <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>CallShortMethodV<font color="black">(</font>obj, method, args<font color="black">)</font>;
    va_end<font color="black">(</font>args<font color="black">)</font>;
    <font color="blue">return</font> result;
  <font color="black">}</font>


  <font color="green">// Static Method Invocations</font>

  jobject JavaEnv<font color="black">:</font><font color="black">:</font>CallStaticObjectMethod<font color="black">(</font>jclass c, jmethodID method, uint n_args, ...<font color="black">)</font> <font color="black">{</font>
    va_list args;
    va_start<font color="black">(</font>args, n_args<font color="black">)</font>;
    JNIEnv<font color="black">*</font> env <font color="black">=</font> GetEnv<font color="black">(</font><font color="black">)</font>;
    jobject result <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>CallStaticObjectMethodV<font color="black">(</font>c, method, args<font color="black">)</font>;
    va_end<font color="black">(</font>args<font color="black">)</font>;

    <font color="blue">return</font> result;
  <font color="black">}</font>

  jint JavaEnv<font color="black">:</font><font color="black">:</font>CallStaticIntMethod<font color="black">(</font>jclass c, jmethodID method, uint n_args, ...<font color="black">)</font> <font color="black">{</font>
    va_list args;
    va_start<font color="black">(</font>args, n_args<font color="black">)</font>;
    JNIEnv<font color="black">*</font> env <font color="black">=</font> GetEnv<font color="black">(</font><font color="black">)</font>;
    jint result <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>CallStaticIntMethodV<font color="black">(</font>c, method, args<font color="black">)</font>;
    va_end<font color="black">(</font>args<font color="black">)</font>;

    <font color="blue">return</font> result;
  <font color="black">}</font>

  jdouble JavaEnv<font color="black">:</font><font color="black">:</font>CallStaticDoubleMethod<font color="black">(</font>jclass c, jmethodID method, uint n_args, ...<font color="black">)</font> <font color="black">{</font>
    va_list args;
    va_start<font color="black">(</font>args, n_args<font color="black">)</font>;
    JNIEnv<font color="black">*</font> env <font color="black">=</font> GetEnv<font color="black">(</font><font color="black">)</font>;
    jdouble result <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>CallStaticDoubleMethodV<font color="black">(</font>c, method, args<font color="black">)</font>;
    va_end<font color="black">(</font>args<font color="black">)</font>;

    <font color="blue">return</font> result;
  <font color="black">}</font>

  jboolean JavaEnv<font color="black">:</font><font color="black">:</font>CallStaticBooleanMethod<font color="black">(</font>jclass c, jmethodID method, uint n_args, ...<font color="black">)</font> <font color="black">{</font>
    va_list args;
    va_start<font color="black">(</font>args, n_args<font color="black">)</font>;
    JNIEnv<font color="black">*</font> env <font color="black">=</font> GetEnv<font color="black">(</font><font color="black">)</font>;
    jboolean result <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>CallStaticBooleanMethodV<font color="black">(</font>c, method, args<font color="black">)</font>;
    va_end<font color="black">(</font>args<font color="black">)</font>;

    <font color="blue">return</font> result;
  <font color="black">}</font>

  jfloat JavaEnv<font color="black">:</font><font color="black">:</font>CallStaticFloatMethod<font color="black">(</font>jclass c, jmethodID method, uint n_args, ...<font color="black">)</font> <font color="black">{</font>
    va_list args;
    va_start<font color="black">(</font>args, n_args<font color="black">)</font>;
    JNIEnv<font color="black">*</font> env <font color="black">=</font> GetEnv<font color="black">(</font><font color="black">)</font>;
    jfloat result <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>CallStaticFloatMethodV<font color="black">(</font>c, method, args<font color="black">)</font>;
    va_end<font color="black">(</font>args<font color="black">)</font>;

    <font color="blue">return</font> result;
  <font color="black">}</font>

  jbyte JavaEnv<font color="black">:</font><font color="black">:</font>CallStaticByteMethod<font color="black">(</font>jclass c, jmethodID method, uint n_args, ...<font color="black">)</font> <font color="black">{</font>
    va_list args;
    va_start<font color="black">(</font>args, n_args<font color="black">)</font>;
    JNIEnv<font color="black">*</font> env <font color="black">=</font> GetEnv<font color="black">(</font><font color="black">)</font>;
    jbyte result <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>CallStaticByteMethodV<font color="black">(</font>c, method, args<font color="black">)</font>;
    va_end<font color="black">(</font>args<font color="black">)</font>;

    <font color="blue">return</font> result;
  <font color="black">}</font>

  jchar JavaEnv<font color="black">:</font><font color="black">:</font>CallStaticCharMethod<font color="black">(</font>jclass c, jmethodID method, uint n_args, ...<font color="black">)</font> <font color="black">{</font>
    va_list args;
    va_start<font color="black">(</font>args, n_args<font color="black">)</font>;
    JNIEnv<font color="black">*</font> env <font color="black">=</font> GetEnv<font color="black">(</font><font color="black">)</font>;
    jchar result <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>CallStaticCharMethodV<font color="black">(</font>c, method, args<font color="black">)</font>;
    va_end<font color="black">(</font>args<font color="black">)</font>;

    <font color="blue">return</font> result;
  <font color="black">}</font>

  jlong JavaEnv<font color="black">:</font><font color="black">:</font>CallStaticLongMethod<font color="black">(</font>jclass c, jmethodID method, uint n_args, ...<font color="black">)</font> <font color="black">{</font>
    va_list args;
    va_start<font color="black">(</font>args, n_args<font color="black">)</font>;
    JNIEnv<font color="black">*</font> env <font color="black">=</font> GetEnv<font color="black">(</font><font color="black">)</font>;
    jlong result <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>CallStaticLongMethodV<font color="black">(</font>c, method, args<font color="black">)</font>;
    va_end<font color="black">(</font>args<font color="black">)</font>;

    <font color="blue">return</font> result;
  <font color="black">}</font>

  jshort JavaEnv<font color="black">:</font><font color="black">:</font>CallStaticShortMethod<font color="black">(</font>jclass c, jmethodID method, uint n_args, ...<font color="black">)</font> <font color="black">{</font>
    va_list args;
    va_start<font color="black">(</font>args, n_args<font color="black">)</font>;
    JNIEnv<font color="black">*</font> env <font color="black">=</font> GetEnv<font color="black">(</font><font color="black">)</font>;
    jshort result <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>CallStaticShortMethodV<font color="black">(</font>c, method, args<font color="black">)</font>;
    va_end<font color="black">(</font>args<font color="black">)</font>;

    <font color="blue">return</font> result;
  <font color="black">}</font>

  JNIValue JavaEnv<font color="black">:</font><font color="black">:</font>CallStatic<font color="black">(</font>jvalue_type ret_type, jclass c, jmethodID method, va_list args<font color="black">)</font> <font color="black">{</font>
    JNIEnv<font color="black">*</font> env <font color="black">=</font> GetEnv<font color="black">(</font><font color="black">)</font>;
    jvalue result;
    <font color="blue">switch</font> <font color="black">(</font>ret_type<font color="black">)</font> <font color="black">{</font>
      <font color="blue">case</font> JBOOLEAN<font color="black">:</font> result.z <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>CallStaticBooleanMethodV <font color="black">(</font>c, method, args<font color="black">)</font>;
      <font color="blue">case</font> JSHORT<font color="black">:</font>   result.s <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>CallStaticShortMethodV   <font color="black">(</font>c, method, args<font color="black">)</font>;
      <font color="blue">case</font> JCHAR<font color="black">:</font>    result.c <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>CallStaticCharMethodV    <font color="black">(</font>c, method, args<font color="black">)</font>;
      <font color="blue">case</font> JVOID<font color="black">:</font>               env<font color="black">-</font><font color="black">&#62;</font>CallStaticVoidMethodV    <font color="black">(</font>c, method, args<font color="black">)</font>;
      <font color="blue">case</font> JBYTE<font color="black">:</font>    result.b <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>CallStaticByteMethodV    <font color="black">(</font>c, method, args<font color="black">)</font>;
      <font color="blue">case</font> JOBJECT<font color="black">:</font>  result.l <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>CallStaticObjectMethodV  <font color="black">(</font>c, method, args<font color="black">)</font>;
      <font color="blue">case</font> JINT<font color="black">:</font>     result.i <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>CallStaticIntMethodV     <font color="black">(</font>c, method, args<font color="black">)</font>;
      <font color="blue">case</font> JLONG<font color="black">:</font>    result.j <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>CallStaticLongMethodV    <font color="black">(</font>c, method, args<font color="black">)</font>;
      <font color="blue">case</font> JDOUBLE<font color="black">:</font>  result.d <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>CallStaticDoubleMethodV  <font color="black">(</font>c, method, args<font color="black">)</font>;
      <font color="blue">case</font> JFLOAT<font color="black">:</font>   result.f <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>CallStaticFloatMethodV   <font color="black">(</font>c, method, args<font color="black">)</font>;
      <font color="blue">default</font><font color="black">:</font> <font color="blue">throw</font> jni_error<font color="black">(</font><font color="maroon">"Unknown jvalue_type"</font><font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">if</font> <font color="black">(</font>env<font color="black">-</font><font color="black">&#62;</font>ExceptionCheck<font color="black">(</font><font color="black">)</font><font color="black">)</font> <font color="black">{</font>
      env<font color="black">-</font><font color="black">&#62;</font>ExceptionDescribe<font color="black">(</font><font color="black">)</font>;
      jthrowable ex <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>ExceptionOccurred<font color="black">(</font><font color="black">)</font>;
      env<font color="black">-</font><font color="black">&#62;</font>ExceptionClear<font color="black">(</font><font color="black">)</font>;
      <font color="blue">throw</font> java_exception<font color="black">(</font><font color="blue">new</font> JNIValue<font color="black">(</font>ex<font color="black">)</font>, QStringLiteral<font color="black">(</font><font color="maroon">"Exception in static method call"</font><font color="black">)</font><font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">return</font> JNIValue<font color="black">(</font>ret_type, result<font color="black">)</font>;
  <font color="black">}</font>


  JNIMethod<font color="black">*</font> JavaEnv<font color="black">:</font><font color="black">:</font>GetMethod<font color="black">(</font>jclass c, <font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> <font color="blue">name</font>, <font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> signature<font color="black">)</font> <font color="black">{</font>
    JNIEnv<font color="black">*</font> env <font color="black">=</font> GetEnv<font color="black">(</font><font color="black">)</font>;
    <font color="green">// TODO: Look up from internal cache =&#62; decentralized as children of JNIClass objects.</font>
    jboolean st <font color="black">=</font> JNI_FALSE;
    jmethodID methodID <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>GetMethodID<font color="black">(</font>c, <font color="blue">name</font>, signature<font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font>methodID <font color="black">=</font><font color="black">=</font> NULL<font color="black">)</font> <font color="black">{</font>
      methodID <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>GetStaticMethodID<font color="black">(</font>c, <font color="blue">name</font>, signature<font color="black">)</font>;
      <font color="blue">if</font> <font color="black">(</font>methodID <font color="black">=</font><font color="black">=</font> NULL<font color="black">)</font> <font color="black">{</font>
        <font color="blue">return</font> NULL;
      <font color="black">}</font>
      st <font color="black">=</font> JNI_TRUE;
    <font color="black">}</font>
    jvalue_type retType <font color="black">=</font> ParseReturnValueFromSignature<font color="black">(</font>signature<font color="black">)</font>;
    vector<font color="black">&#60;</font>jvalue_type<font color="black">&#62;</font> paramTypes <font color="black">=</font> ParseArgumentTypesFromSignature<font color="black">(</font>signature<font color="black">)</font>;
    <font color="blue">return</font> <font color="blue">new</font> JNIMethod<font color="black">(</font><font color="blue">name</font>, c, retType, paramTypes, st, methodID<font color="black">)</font>;
  <font color="black">}</font>

  jstring JavaEnv<font color="black">:</font><font color="black">:</font>CreateString<font color="black">(</font><font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> str<font color="black">)</font> <font color="black">{</font>
    JNIEnv<font color="black">*</font> env <font color="black">=</font> GetEnv<font color="black">(</font><font color="black">)</font>;
    <font color="blue">return</font> env<font color="black">-</font><font color="black">&#62;</font>NewStringUTF<font color="black">(</font>str<font color="black">)</font>;
  <font color="black">}</font>

  QString JavaEnv<font color="black">:</font><font color="black">:</font>GetString<font color="black">(</font>JNIValue str<font color="black">)</font> <font color="black">{</font>
    JNIEnv<font color="black">*</font> env <font color="black">=</font> GetEnv<font color="black">(</font><font color="black">)</font>;
    jstring param <font color="black">=</font> static_cast<font color="black">&#60;</font>jstring<font color="black">&#62;</font><font color="black">(</font>str.GetJObject<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
    <font color="blue">return</font> QString<font color="black">(</font>env<font color="black">-</font><font color="black">&#62;</font>GetStringUTFChars<font color="black">(</font>param, NULL<font color="black">)</font><font color="black">)</font>;
  <font color="black">}</font>

  QString JavaEnv<font color="black">:</font><font color="black">:</font>GetString<font color="black">(</font>jstring str<font color="black">)</font> <font color="black">{</font>
    JNIEnv<font color="black">*</font> env <font color="black">=</font> GetEnv<font color="black">(</font><font color="black">)</font>;
    <font color="blue">return</font> QString<font color="black">(</font>env<font color="black">-</font><font color="black">&#62;</font>GetStringUTFChars<font color="black">(</font>str, NULL<font color="black">)</font><font color="black">)</font>;
  <font color="black">}</font>

  jvalue_type JavaEnv<font color="black">:</font><font color="black">:</font>ParseReturnValueFromSignature<font color="black">(</font><font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> signature<font color="black">)</font> <font color="black">{</font>
    std<font color="black">:</font><font color="black">:</font>string sig <font color="black">(</font>signature<font color="black">)</font>;
    uint index <font color="black">=</font> sig.find_last_of<font color="black">(</font><font color="maroon">')'</font><font color="black">)</font> <font color="black">+</font> <font color="maroon">1</font>;
    <font color="blue">if</font> <font color="black">(</font>index <font color="black">&#60;</font> sig.length<font color="black">(</font><font color="black">)</font><font color="black">)</font> <font color="black">{</font>
      <font color="blue">char</font> c <font color="black">=</font> sig.at<font color="black">(</font>index<font color="black">)</font>;
      <font color="blue">switch</font> <font color="black">(</font>c<font color="black">)</font> <font color="black">{</font>
        <font color="blue">case</font> <font color="maroon">'Z'</font><font color="black">:</font> <font color="blue">return</font> JBOOLEAN;
        <font color="blue">case</font> <font color="maroon">'S'</font><font color="black">:</font> <font color="blue">return</font> JSHORT;
        <font color="blue">case</font> <font color="maroon">'C'</font><font color="black">:</font> <font color="blue">return</font> JCHAR;
        <font color="blue">case</font> <font color="maroon">'V'</font><font color="black">:</font> <font color="blue">return</font> JVOID;
        <font color="blue">case</font> <font color="maroon">'B'</font><font color="black">:</font> <font color="blue">return</font> JBYTE;
        <font color="blue">case</font> <font color="maroon">'L'</font><font color="black">:</font> <font color="blue">return</font> JOBJECT;
        <font color="blue">case</font> <font color="maroon">'I'</font><font color="black">:</font> <font color="blue">return</font> JINT;
        <font color="blue">case</font> <font color="maroon">'J'</font><font color="black">:</font> <font color="blue">return</font> JLONG;
        <font color="blue">case</font> <font color="maroon">'D'</font><font color="black">:</font> <font color="blue">return</font> JDOUBLE;
        <font color="blue">case</font> <font color="maroon">'F'</font><font color="black">:</font> <font color="blue">return</font> JFLOAT;
      <font color="black">}</font>
    <font color="black">}</font>
    <font color="blue">throw</font> runtime_error<font color="black">(</font><font color="maroon">"Invalid signature"</font><font color="black">)</font>;
  <font color="black">}</font>

  vector<font color="black">&#60;</font>jvalue_type<font color="black">&#62;</font> JavaEnv<font color="black">:</font><font color="black">:</font>ParseArgumentTypesFromSignature<font color="black">(</font><font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> signature<font color="black">)</font> <font color="black">{</font>
    std<font color="black">:</font><font color="black">:</font>string sig <font color="black">(</font>signature<font color="black">)</font>;
    vector<font color="black">&#60;</font>jvalue_type<font color="black">&#62;</font> arguments;
    uint index <font color="black">=</font> <font color="maroon">0</font>;
    uint end <font color="black">=</font> sig.find_last_of<font color="black">(</font><font color="maroon">')'</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font>end <font color="black">&#62;</font><font color="black">=</font> sig.length<font color="black">(</font><font color="black">)</font><font color="black">)</font> <font color="black">{</font>
        <font color="blue">throw</font> runtime_error<font color="black">(</font><font color="maroon">"Invalid signature"</font><font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">while</font> <font color="black">(</font>index <font color="black">&#60;</font> end<font color="black">)</font> <font color="black">{</font>
        <font color="blue">char</font> c <font color="black">=</font> sig.at<font color="black">(</font>index<font color="black">+</font><font color="black">+</font><font color="black">)</font>;
        <font color="blue">switch</font><font color="black">(</font>c<font color="black">)</font> <font color="black">{</font>
        <font color="blue">case</font> <font color="maroon">'Z'</font><font color="black">:</font> arguments.push_back<font color="black">(</font>JBOOLEAN<font color="black">)</font>; <font color="blue">break</font>;
        <font color="blue">case</font> <font color="maroon">'S'</font><font color="black">:</font> arguments.push_back<font color="black">(</font>JSHORT<font color="black">)</font>;   <font color="blue">break</font>;
        <font color="blue">case</font> <font color="maroon">'C'</font><font color="black">:</font> arguments.push_back<font color="black">(</font>JCHAR<font color="black">)</font>;   <font color="blue">break</font>;
        <font color="blue">case</font> <font color="maroon">'B'</font><font color="black">:</font> arguments.push_back<font color="black">(</font>JBYTE<font color="black">)</font>;   <font color="blue">break</font>;
        <font color="blue">case</font> <font color="maroon">'I'</font><font color="black">:</font> arguments.push_back<font color="black">(</font>JINT<font color="black">)</font>; <font color="blue">break</font>;
        <font color="blue">case</font> <font color="maroon">'J'</font><font color="black">:</font> arguments.push_back<font color="black">(</font>JLONG<font color="black">)</font>; <font color="blue">break</font>;
        <font color="blue">case</font> <font color="maroon">'D'</font><font color="black">:</font> arguments.push_back<font color="black">(</font>JDOUBLE<font color="black">)</font>; <font color="blue">break</font>;
        <font color="blue">case</font> <font color="maroon">'F'</font><font color="black">:</font> arguments.push_back<font color="black">(</font>JFLOAT<font color="black">)</font>; <font color="blue">break</font>;
        <font color="blue">case</font> <font color="maroon">'L'</font><font color="black">:</font> <font color="black">{</font>
              arguments.push_back<font color="black">(</font>JOBJECT<font color="black">)</font>;
              <font color="green">// For object types, the substring denoting the class should be skipped before continuing.</font>
              index <font color="black">=</font> sig.find_first_of<font color="black">(</font><font color="maroon">';'</font>, index<font color="black">)</font><font color="black">+</font><font color="maroon">1</font>;
              <font color="blue">break</font>;
            <font color="black">}</font>
        <font color="blue">default</font><font color="black">:</font>
            qWarning<font color="black">(</font><font color="black">)</font> <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"unrecognized type: "</font> <font color="black">&#60;</font><font color="black">&#60;</font> c;
        <font color="black">}</font>
    <font color="black">}</font>
    <font color="blue">return</font> arguments;
  <font color="black">}</font>

  <font color="blue">bool</font> JavaEnv<font color="black">:</font><font color="black">:</font>isAttached<font color="black">(</font>QThread<font color="black">*</font> thread<font color="black">)</font> <font color="black">{</font>
    <font color="blue">if</font><font color="black">(</font>thread<font color="black">-</font><font color="black">&#62;</font>isRunning<font color="black">(</font><font color="black">)</font><font color="black">)</font> <font color="black">{</font>
      <font color="blue">return</font> environments.contains<font color="black">(</font>thread<font color="black">)</font>;
    <font color="black">}</font> <font color="blue">else</font> <font color="black">{</font>
      environments.remove<font color="black">(</font>thread<font color="black">)</font>;
      <font color="blue">return</font> <font color="blue">false</font>;
    <font color="black">}</font>
  <font color="black">}</font>

  <font color="blue">void</font> JavaEnv<font color="black">:</font><font color="black">:</font>syncJavaVMThreads<font color="black">(</font><font color="black">)</font> <font color="black">{</font>
    QList<font color="black">&#60;</font>QThread<font color="black">*</font><font color="black">&#62;</font> threads <font color="black">=</font> environments.keys<font color="black">(</font><font color="black">)</font>;
    <font color="blue">for</font> <font color="black">(</font>QList<font color="black">&#60;</font>QThread<font color="black">*</font><font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>iterator it <font color="black">=</font> threads.begin<font color="black">(</font><font color="black">)</font>; it <font color="black">!</font><font color="black">=</font> threads.end<font color="black">(</font><font color="black">)</font>; <font color="black">+</font><font color="black">+</font>it<font color="black">)</font> <font color="black">{</font>
      QThread<font color="black">*</font> key <font color="black">=</font> <font color="black">(</font><font color="black">*</font>it<font color="black">)</font>;
      <font color="blue">if</font> <font color="black">(</font>key<font color="black">-</font><font color="black">&#62;</font>isFinished<font color="black">(</font><font color="black">)</font><font color="black">)</font> <font color="black">{</font>
        environments.remove<font color="black">(</font>key<font color="black">)</font>;
      <font color="black">}</font>
    <font color="black">}</font>
  <font color="black">}</font>

  <font color="blue">void</font> JavaEnv<font color="black">:</font><font color="black">:</font>unlinkThread<font color="black">(</font><font color="black">)</font> <font color="black">{</font>
    QThread<font color="black">*</font> current <font color="black">=</font> QThread<font color="black">:</font><font color="black">:</font>currentThread<font color="black">(</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> environments.remove<font color="black">(</font>current<font color="black">)</font> <font color="black">!</font><font color="black">=</font> <font color="maroon">0</font><font color="black">)</font> <font color="black">{</font>
      jvm<font color="black">-</font><font color="black">&#62;</font>DetachCurrentThread<font color="black">(</font><font color="black">)</font>;
    <font color="black">}</font>
  <font color="black">}</font>
<font color="black">}</font>

</PRE>
</BODY>
</HTML>
