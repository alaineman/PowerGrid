<HTML>
<HEAD>
<TITLE>
javaenv.h
</TITLE>
</HEAD>
<BODY>
<PRE>
<font color="blue">#ifndef</font> JAVAENV_H
<font color="blue">#define</font> JAVAENV_H

<font color="blue">#include</font> <font color="maroon">&#60;jni.h&#62;</font>
<font color="blue">#include</font> <font color="maroon">"jnimethod.h"</font>
<font color="blue">#include</font> <font color="maroon">&#60;QMap&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;QHash&#62;</font>
<font color="blue">#include</font> <font color="maroon">"jniclass.h"</font>

<font color="blue">namespace</font> jni <font color="black">{</font>
  <font color="blue">using</font> <font color="blue">namespace</font> std;
  <font color="green">/**
   * The JavaEnv class is a C++ wrapper around the Java environment (JNIEnv struct).
   * The functions this class provides checks for illegal arguments, like NULL values.
   * The original JNI does not do this, and as such errors could occur when providing the
   * JNI with such arguments.
   */</font>
  <font color="blue">class</font> JavaEnv <font color="black">:</font> <font color="blue">public</font> QObject <font color="black">{</font>
  <font color="blue">private</font><font color="black">:</font>
    JavaVM<font color="black">*</font> jvm;
    jboolean running;
    QMap<font color="black">&#60;</font>QThread<font color="black">*</font>, JNIEnv<font color="black">*</font><font color="black">&#62;</font> environments;
    QMap<font color="black">&#60;</font>QString, JNIClass<font color="black">*</font><font color="black">&#62;</font> classes;
  <font color="blue">public</font><font color="black">:</font>
    <font color="green">/// Constructs a new JavaEnv object.</font>
    JavaEnv<font color="black">(</font><font color="black">)</font>;

    <font color="green">/**
     * @brief Returns the JNI environment object for the calling thread
     *
     * Calling this before calling @c Start() does not give a valid JNIEnv object pointer.
     * When a thread is not linked to the JVM, the thread is automatically linked to it, and
     * the corresponding JNIEnv object is stored for future reference.
     * @return a pointer to the JNI environment
     */</font>
    JNIEnv<font color="black">*</font> GetEnv<font color="black">(</font><font color="black">)</font>;

    <font color="green">/**
     * @brief Returns the JavaVM object
     * Calling this before calling @c Start() does not give a valid JavaVM object pointer.
     * @return a pointer to the JavaVM
     */</font>
    JavaVM<font color="black">*</font> GetJVM<font color="black">(</font><font color="black">)</font> <font color="black">{</font> <font color="blue">return</font> jvm; <font color="black">}</font>

    <font color="green">/**
     * @brief Returns whether the JNI environment is running.
     * @return true if the JNI environment is running, false otherwise.
     */</font>
    jboolean IsRunning<font color="black">(</font><font color="black">)</font> <font color="black">{</font> <font color="blue">return</font> running; <font color="black">}</font>

    <font color="green">/**
     * @brief Starts the JNI environment
     *
     * Calling this function results in the JNI environment being set up. This function then calls the main method
     * of the jagexappletviewer jar file afterwards. This function returns when the main method in the JVM returns.
     * That is to say, when the intial loading screen of Runescape disappears.
     */</font>
    <font color="blue">void</font> Start<font color="black">(</font><font color="black">)</font>;

    <font color="green">/**
     * @brief Returns the class with the given name
     * @param name the name of the requested class
     * @return a pointer to the JNIClass object with the requested name, or NULL if no class exists with the given name.
     */</font>
    JNIClass<font color="black">*</font> GetClass<font color="black">(</font><font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> <font color="blue">name</font><font color="black">)</font>;

    <font color="green">/**
     * @brief Returns the method ID with the given requirements.
     * @param c the class in which the method is declared
     * @param name the name of the method
     * @param signature the signature of the method
     *
     * Use the GetStaticMethodID function for static methods, because they are handled in a different way in the JNI.
     *
     * @return the jmethodID object representing the method with the given requirements, or NULL is the method was not found.
     */</font>
    jmethodID GetMethodID<font color="black">(</font>JNIClass<font color="black">*</font> c, <font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> <font color="blue">name</font>, <font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> signature<font color="black">)</font>;

    <font color="green">/**
     * @brief Returns the static method ID with the given requirements.
     * @param c the class in which the static method is declared
     * @param name the name of the static method
     * @param signature the signature of the static method
     *
     * Use the GetMethodID function for non-static methods, because they are handled in a different way in the JNI.
     *
     * @return the jmethodID object representing the static method with the given requirements, or NULL is the method was not found.
     */</font>
    jmethodID GetStaticMethodID<font color="black">(</font>JNIClass<font color="black">*</font> c, <font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> <font color="blue">name</font>, <font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> signature<font color="black">)</font>;

    <font color="green">/**
     * @brief Returns the Java Virtual machine version
     *
     * This function call performs the following Java method invocation:
     * &#60;pre&#62;
     *     System.getProperty("java.version");
     * &#60;/pre&#62;
     * and returns the result as a QString
     *
     * @return the version of the JVM as a QString
     */</font>
    QString GetEnvironmentVersion<font color="black">(</font><font color="black">)</font>;

    <font color="green">/// Safe version of the object method invocation function from JNI.</font>
    jobject  CallObjectMethod  <font color="black">(</font>jobject obj, jmethodID method, uint n_args, ...<font color="black">)</font>;
    <font color="green">/// Safe version of the int method invocation function from JNI.</font>
    jint     CallIntMethod     <font color="black">(</font>jobject obj, jmethodID method, uint n_args, ...<font color="black">)</font>;
    <font color="green">/// Safe version of the double method invocation function from JNI.</font>
    jdouble  CallDoubleMethod  <font color="black">(</font>jobject obj, jmethodID method, uint n_args, ...<font color="black">)</font>;
    <font color="green">/// Safe version of the boolean method invocation function from JNI.</font>
    jboolean CallBooleanMethod <font color="black">(</font>jobject obj, jmethodID method, uint n_args, ...<font color="black">)</font>;
    <font color="green">/// Safe version of the float method invocation function from JNI.</font>
    jfloat   CallFloatMethod   <font color="black">(</font>jobject obj, jmethodID method, uint n_args, ...<font color="black">)</font>;
    <font color="green">/// Safe version of the byte method invocation function from JNI.</font>
    jbyte    CallByteMethod    <font color="black">(</font>jobject obj, jmethodID method, uint n_args, ...<font color="black">)</font>;
    <font color="green">/// Safe version of the char method invocation function from JNI.</font>
    jchar    CallCharMethod    <font color="black">(</font>jobject obj, jmethodID method, uint n_args, ...<font color="black">)</font>;
    <font color="green">/// Safe version of the long method invocation function from JNI.</font>
    jlong    CallLongMethod    <font color="black">(</font>jobject obj, jmethodID method, uint n_args, ...<font color="black">)</font>;
    <font color="green">/// Safe version of the short method invocation function from JNI.</font>
    jshort   CallShortMethod   <font color="black">(</font>jobject obj, jmethodID method, uint n_args, ...<font color="black">)</font>;

    <font color="green">/// Safe version of the static object method invocation function from JNI.</font>
    jobject  CallStaticObjectMethod  <font color="black">(</font>jclass c, jmethodID method, uint n_args, ...<font color="black">)</font>;
    <font color="green">/// Safe version of the static int method invocation function from JNI.</font>
    jint     CallStaticIntMethod     <font color="black">(</font>jclass c, jmethodID method, uint n_args, ...<font color="black">)</font>;
    <font color="green">/// Safe version of the static double method invocation function from JNI.</font>
    jdouble  CallStaticDoubleMethod  <font color="black">(</font>jclass c, jmethodID method, uint n_args, ...<font color="black">)</font>;
    <font color="green">/// Safe version of the static boolean method invocation function from JNI.</font>
    jboolean CallStaticBooleanMethod <font color="black">(</font>jclass c, jmethodID method, uint n_args, ...<font color="black">)</font>;
    <font color="green">/// Safe version of the static float method invocation function from JNI.</font>
    jfloat   CallStaticFloatMethod   <font color="black">(</font>jclass c, jmethodID method, uint n_args, ...<font color="black">)</font>;
    <font color="green">/// Safe version of the static byte method invocation function from JNI.</font>
    jbyte    CallStaticByteMethod    <font color="black">(</font>jclass c, jmethodID method, uint n_args, ...<font color="black">)</font>;
    <font color="green">/// Safe version of the static char method invocation function from JNI.</font>
    jchar    CallStaticCharMethod    <font color="black">(</font>jclass c, jmethodID method, uint n_args, ...<font color="black">)</font>;
    <font color="green">/// Safe version of the static long method invocation function from JNI.</font>
    jlong    CallStaticLongMethod    <font color="black">(</font>jclass c, jmethodID method, uint n_args, ...<font color="black">)</font>;
    <font color="green">/// Safe version of the static short method invocation function from JNI.</font>
    jshort   CallStaticShortMethod   <font color="black">(</font>jclass c, jmethodID method, uint n_args, ...<font color="black">)</font>;

    <font color="green">/**
     * @brief Calls the provided (non-static) method
     * @param ret_type the expected return type
     * @param c the object to perform the method call on
     * @param method the id of the method to invoke
     * @param args the arguments to the method call
     * @return a JNIValue with the result of the performed method call.
     */</font>
    JNIValue Call<font color="black">(</font>jvalue_type ret_type, jobject c, jmethodID method, va_list args<font color="black">)</font>;
    <font color="green">/**
     * @brief Calls the provided static method
     * @param ret_type the expected return type
     * @param c the class to perform the static method call on
     * @param method the id of the static method to invoke
     * @param args the arguments to the static method call
     * @return a JNIValue with the result of the performed static method call.
     */</font>
    JNIValue CallStatic<font color="black">(</font>jvalue_type ret_type, jclass c, jmethodID method, va_list args<font color="black">)</font>;

    <font color="green">/**
     * @brief Retrieves information on the method specified by the given parameters
     *
     * @param c the class the method is declared in
     * @param name the name of the method
     * @param signature the signature of the method
     *
     * This method is completely type-safe regarding input and output.
     *
     * @return a pointer to the JNIMethod object containing the method information of the
     *         requested method, or NULL if the method does not exist in the JVM.
     */</font>
    JNIMethod<font color="black">*</font> GetMethod<font color="black">(</font>jclass c, <font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> <font color="blue">name</font>, <font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> signature<font color="black">)</font>;

    <font color="green">/**
     * @brief Creates a String in the Java environment's  String pool
     * @param str the string to create
     * @return a jstring object that references the created Java String.
     */</font>
    jstring CreateString<font color="black">(</font><font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> str<font color="black">)</font>;

    <font color="green">/**
     * @brief Collects the given jstring from the Java environment and returns it as a QString
     * @param str the jstring to collect
     * @return the QString with the contents of the provided jstring
     */</font>
    QString GetString<font color="black">(</font>jstring str<font color="black">)</font>;

    <font color="green">/**
     * @brief Collects the given JNIValue from the Java environment and returns it as a QString
     *
     * If the provided JNIValue is not of the JOBJECT type, this function throws a runtime_error.
     * @param str the JNIValue to collect
     * @return the QString with the contents of the provided jstring
     */</font>
    QString GetString<font color="black">(</font>JNIValue str<font color="black">)</font>;

    <font color="green">/**
     * @brief Parses the return value from a Java method signature
     * @param signature the signture to parse
     * @return the jvalue_type of the return value of the given method signature
     */</font>
    jvalue_type ParseReturnValueFromSignature<font color="black">(</font><font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> signature<font color="black">)</font>;

    <font color="green">/**
     * @brief Parses the argument types
     * @param signature
     * @return
     */</font>
    vector<font color="black">&#60;</font>jvalue_type<font color="black">&#62;</font> ParseArgumentTypesFromSignature<font color="black">(</font><font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> signature<font color="black">)</font>;

    <font color="green">/**
     * @brief Checks each registered thread - JNIEnv mapping for validity
     * For each thread that has already finished, the corresponding JNIEnv object is removed.
     *
     * It is advised to use the @c unlinkThread() slot instead, because it prevents illegal references from remaining in the thread to JNIEnv mapping.
     *
     */</font>
    <font color="blue">void</font> syncJavaVMThreads<font color="black">(</font><font color="black">)</font>;

    <font color="green">/**
     * @brief Checks if the given QThread is attached to the Java VM
     * @param thread the QThread to check
     * @return true if and only if the thread is still running and has a binding to a JNIEnv object, false otherwise.
     */</font>
    <font color="blue">bool</font> isAttached<font color="black">(</font>QThread<font color="black">*</font> thread<font color="black">)</font>;

  signals<font color="black">:</font>
    <font color="green">/// Signal that the JNI environment has started</font>
    <font color="blue">void</font> started<font color="black">(</font><font color="black">)</font>;
    <font color="green">/// Signal that the JNI environment has stopped.</font>
    <font color="blue">void</font> stopped<font color="black">(</font><font color="black">)</font>;

  <font color="blue">public</font> slots<font color="black">:</font>
    <font color="green">/**
     * @brief Unlinks the current thread from the Java VM
     * After this method returns, the JNIEnv object associated with this thread has been removed.
     * Note that calling any other JavaEnv function that requires a JNIEnv object, the JNIEnv object
     * will be re-created.
     *
     * This function can be linked to QThread's finished() signal to cleanly detach the thread and the remove the JNIEnv.
     * Alternatively, the syncJavaVMThreads() function can be called to check each registered thread and JNIEnv for validity.
     */</font>
    <font color="blue">void</font> unlinkThread<font color="black">(</font><font color="black">)</font>;
  <font color="black">}</font>;
<font color="black">}</font>

<font color="blue">#endif</font> <font color="green">// JAVAENV_H</font>

</PRE>
</BODY>
</HTML>
