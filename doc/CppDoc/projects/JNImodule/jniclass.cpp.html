<HTML>
<HEAD>
<TITLE>
jniclass.cpp
</TITLE>
</HEAD>
<BODY>
<PRE>
<font color="blue">#include</font> <font color="maroon">"jniclass.h"</font>
<font color="blue">#include</font> <font color="maroon">"javaenv.h"</font>
<font color="blue">#include</font> <font color="maroon">"jniexception.h"</font>

<font color="blue">namespace</font> jni <font color="black">{</font>
  QString JNIClass<font color="black">:</font><font color="black">:</font>GetSigName<font color="black">(</font><font color="black">)</font> <font color="black">{</font>
    <font color="blue">if</font> <font color="black">(</font><font color="blue">name</font> <font color="black">=</font><font color="black">=</font> NULL<font color="black">)</font> <font color="black">{</font>
      JNIClass<font color="black">*</font> cls <font color="black">=</font> GetClass<font color="black">(</font><font color="black">)</font>;
      jclass c <font color="black">=</font> <font color="black">(</font>jclass<font color="black">)</font> cls<font color="black">-</font><font color="black">&#62;</font>GetJavaObject<font color="black">(</font><font color="black">)</font>;
      JNIEnv<font color="black">*</font> e <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>GetEnv<font color="black">(</font><font color="black">)</font>;
      jmethodID getName <font color="black">=</font> e<font color="black">-</font><font color="black">&#62;</font>GetMethodID<font color="black">(</font>c, <font color="maroon">"getName"</font>, <font color="maroon">"()Ljava/lang/String;"</font><font color="black">)</font>;
      jstring n <font color="black">=</font> <font color="black">(</font>jstring<font color="black">)</font> e<font color="black">-</font><font color="black">&#62;</font>CallObjectMethod<font color="black">(</font>c, getName<font color="black">)</font>;
      <font color="blue">name</font> <font color="black">=</font> <font color="blue">new</font> QString<font color="black">(</font>env<font color="black">-</font><font color="black">&#62;</font>GetString<font color="black">(</font>n<font color="black">)</font><font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">return</font> <font color="black">*</font><font color="blue">name</font>;
  <font color="black">}</font>

  QString JNIClass<font color="black">:</font><font color="black">:</font>GetSimpleName<font color="black">(</font><font color="black">)</font> <font color="black">{</font>
    QString signame <font color="black">=</font> GetSigName<font color="black">(</font><font color="black">)</font>;
    <font color="blue">int</font> first <font color="black">=</font> signame.lastIndexOf<font color="black">(</font><font color="maroon">"/"</font><font color="black">)</font> <font color="black">+</font> <font color="maroon">1</font>;
    <font color="blue">return</font> signame.right<font color="black">(</font>signame.length<font color="black">(</font><font color="black">)</font> <font color="black">-</font>first<font color="black">)</font>;
  <font color="black">}</font>

  jboolean JNIClass<font color="black">:</font><font color="black">:</font>IsInstance<font color="black">(</font>JNIObject o<font color="black">)</font> <font color="black">{</font>
    <font color="blue">return</font> IsInstance<font color="black">(</font>o.GetJObject<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
  <font color="black">}</font>

  jboolean JNIClass<font color="black">:</font><font color="black">:</font>IsInstance<font color="black">(</font>jobject o<font color="black">)</font> <font color="black">{</font>
    <font color="blue">return</font> env<font color="black">-</font><font color="black">&#62;</font>GetEnv<font color="black">(</font><font color="black">)</font><font color="black">-</font><font color="black">&#62;</font>IsInstanceOf<font color="black">(</font>o, clazz<font color="black">)</font>;
  <font color="black">}</font>

  JNIMethod<font color="black">*</font> JNIClass<font color="black">:</font><font color="black">:</font>GetMethod<font color="black">(</font><font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> <font color="blue">name</font>, <font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> signature<font color="black">)</font> <font color="black">{</font>
    <font color="blue">return</font> env<font color="black">-</font><font color="black">&#62;</font>GetMethod<font color="black">(</font>clazz, <font color="blue">name</font>, signature<font color="black">)</font>;
  <font color="black">}</font>

  JNIValue JNIClass<font color="black">:</font><font color="black">:</font>InvokeStaticMethod<font color="black">(</font>JNIMethod <font color="black">*</font>method, ...<font color="black">)</font> <font color="black">{</font>
    <font color="blue">if</font> <font color="black">(</font>method <font color="black">=</font><font color="black">=</font> NULL<font color="black">)</font> <font color="black">{</font>
      <font color="blue">throw</font> jni_error<font color="black">(</font><font color="maroon">"Method is NULL"</font><font color="black">)</font>;
    <font color="black">}</font>
    jvalue_type type <font color="black">=</font> method<font color="black">-</font><font color="black">&#62;</font>GetReturnType<font color="black">(</font><font color="black">)</font>;
    va_list args;
    <font color="blue">int</font> count <font color="black">=</font> static_cast<font color="black">&#60;</font><font color="blue">int</font><font color="black">&#62;</font><font color="black">(</font>method<font color="black">-</font><font color="black">&#62;</font>GetArgumentCount<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
    va_start<font color="black">(</font>args, count<font color="black">)</font>;
    JNIValue result <font color="black">=</font> env<font color="black">-</font><font color="black">&#62;</font>CallStatic<font color="black">(</font>type, clazz, method<font color="black">-</font><font color="black">&#62;</font>GetMethodID<font color="black">(</font><font color="black">)</font>, args<font color="black">)</font>;
    va_end<font color="black">(</font>args<font color="black">)</font>;
    <font color="blue">return</font> result;
  <font color="black">}</font>
<font color="black">}</font>

</PRE>
</BODY>
</HTML>
